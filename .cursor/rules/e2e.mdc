---
description: E2E 테스트 – Playwright Test Agents (planner/generator/healer) + TODO 시나리오 문서 기반
globs:
  - "e2e/**/*.{ts,tsx}"
  - "tests/**/*.{ts,tsx}"
  - "specs/**/*.md"
alwaysApply: true
---

# E2E 테스트 규칙 (Playwright + Agents)

Next.js(App Router) + Playwright Test + Playwright Test Agents를 사용할 때 따르는 규칙입니다.

## 1. 기본 원칙
- 사람이 작성한 **TODO 시나리오 문서**(`e2e/specs/*.todo.md`)를 진실의 근원으로 삼습니다.
- Playwright Test Agents 흐름(planner → generator → healer)을 따른다.
- 테스트는 **사용자 관점(User journey)** 우선, 구현 디테일 의존 최소화.
- 앱 코드가 아닌 **테스트 코드만** 수정한다.

## 2. 디렉터리/파일
- TODO 문서: `e2e/specs/{feature}/**.todo.md`
- Planner 출력: `specs/{feature}.md` (steps/expected로 구조화, 필요 시 `Origin: planner-suggested` 메모)
- Generator 출력: `e2e/tests/{feature}/**.spec.ts`
- 기능별 폴더 구조 일치, 전제 접미사(`.auth|.guest|.common.spec.ts`).

## 3. Planner
- 입력: seed test(`tests/seed.spec.ts`) 필수, TODO/PRD/디자인 선택.
- seed 실행 후 앱 탐색, TODO 시나리오를 steps/expected로 나눈 Markdown 플랜을 `specs/*.md`에 작성.
- locator는 박지 않고 “무엇을 검증할지”만 기술, 테스트 코드는 생성하지 않음.

## 4. Generator
- 입력: `specs/*.md`, seed test, `playwright.config.ts`.
- 출력: `e2e/tests/**.spec.ts`.
- 파일/테스트명: 기능+시나리오 조합(예: `post-like-guest.spec.ts`), 시나리오 설명을 명확히 사용.
- 라우트 하드코딩 금지 → constants 사용, 없으면 오류 알리고 중단. `use.baseURL` 활용.
- 네비게이션 후 `waitForLoadState('networkidle')` 또는 주요 요소 가시성 확인, `waitForTimeout` 금지.
- Locator 우선순위: `getByTestId` → `getByRole` → `getByLabel` → `getByText` → `locator`(최후). 다른 로케이터는 `// locator-justification` 주석.
- Assertion: web-first `expect`, 동기 `expect`+`isVisible` 금지, 중요/부수 결과 hard/soft 구분.
- 로그인/권한: 기존 fixture/helper 우선. 스크린샷/비디오/trace는 실패 시 캡처 설정 유지.

## 5. Healer
- 실패 테스트 재실행·조사 후 locator/타이밍/텍스트 등 **테스트 코드만** 수정.
- 순서: 실패 식별 → 재실행 및 스냅샷/콘솔/네트워크 조사 → 패치 → 재실행 결과 보고.
- 금지: 앱 코드 수정, 느슨한 assertion으로 억지 통과, TODO/PRD 무시. 필요 시 `test.skip` 또는 TODO 메모.

## 6. 추가 공통 규칙
- 실행 커맨드: 전체 `yarn test:e2e`, 게스트 `yarn test:e2e:guest`, 인증 `yarn test:e2e:auth`, UI `yarn test:e2e:ui`, headed `yarn test:e2e:headed`, 리포트 `yarn test:e2e:report`.
- 상태 공유 금지, 시드/정리 필수, 하드코딩 URL·시크릿 금지.
- TestID-First: 주요 요소에 `data-testid`, 케밥케이스 사용. 다른 로케이터는 주석 근거.
- 플레키: 원인 기록 후 `test.fixme`, 7일 내 복구. 태깅은 `[smoke]`, `[slow]` 등.
- DoD: 제목에 목적/사용자 행위, `getByTestId` 우선, 데이터 격리, 전제 접미사, 아티팩트(trace/video/screenshot) 확인, CI 안정성 확보, TODO/PRD 충족 여부 확인.
